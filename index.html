<!-- untiedlaces , 02 3 , bxr , hd -->
<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>‚ö° project silica 404sec</title>
  <script src="https://unpkg.com/peerjs@1.5.2/dist/peerjs.min.js"></script>
  <style>
    * { box-sizing: border-box; margin: 0; padding: 0 }
    body {
      display: flex; flex-direction: column;
      height: 100vh; background: #000;
      color: #0f0; font-family: monospace;
      padding: 20px;
    }
    h2 { margin-bottom: 12px }
    /* Chat area */
    #chatbox {
      flex: 1; overflow-y: auto;
      background: #111; border: 1px solid #0f0;
      padding: 10px; margin-bottom: 10px;
    }
    .message {
      display: flex; align-items: center;
      margin-bottom: 8px;
    }
    .avatar {
      width: 36px; height: 36px; object-fit: cover;
      border: 1px solid #0f0; border-radius: 4px;
      margin-right: 8px;
    }
    .text { line-height: 1.4 }
    .system { opacity: 0.6; font-style: italic }
    /* Panels */
    #peerArea, #roomArea {
      display: flex; align-items: center;
      gap: 8px; margin-bottom: 12px;
    }
    input, select, button {
      background: #111; color: #0f0;
      border: 1px solid #0f0; padding: 6px 10px;
      font-family: monospace; font-size: 1em;
    }
    input[readonly] { cursor: text }
    button:disabled { opacity: 0.4; cursor: not-allowed }
    #connections {
      margin-bottom: 12px; font-size: 0.9em;
    }
    .conn-item {
      display: flex; justify-content: space-between;
      padding: 4px; border: 1px solid #0f0;
      margin-top: 4px;
    }
    /* Avatar/Lock (kept minimal) */
    #avatarPicker, #lockScreen {
      position: fixed; inset: 0; display: none;
      background: rgba(0,0,0,0.95);
      flex-direction: column; align-items: center;
      justify-content: center; z-index: 10;
    }
    #avatarPicker.active, #lockScreen.active { display: flex }
    #avatarGrid {
      display: grid; grid-template-columns: repeat(3,80px);
      gap: 12px; margin: 12px 0;
    }
    #avatarGrid img {
      width: 70px; cursor: pointer;
      border: 1px solid #0f0;
    }
    .avatar-option { margin-top: 10px }
  </style>
</head>
<body oncontextmenu="return false;">

  <!-- Avatar Picker -->
  <div id="avatarPicker" class="active">
    <h3>üßô Choose Your Avatar</h3>
    <button onclick="refreshAvatars()">üîÑ Refresh</button>
    <div id="avatarGrid"></div>
    <div class="avatar-option">
      <button onclick="chooseAvatar('https://via.placeholder.com/40/000')">
        Use Black Avatar
      </button>
    </div>
    <div class="avatar-option">
      <input id="customURL" placeholder="Custom URL‚Ä¶" />
      <button onclick="useCustomURL()">OK</button>
    </div>
    <p style="font-size:12px;">
      Avatars by Dicebear | Or supply your own URL
    </p>
  </div>

  <!-- Lock Screen -->
  <div id="lockScreen">
    <h2>üîê Enter Password</h2>
    <form id="unlockForm">
      <input type="password" id="passwordInput"
             placeholder="Password" required autocomplete="off" />
      <button type="submit">Unlock</button>
    </form>
    <p id="passwordMsg" style="color:red; margin-top:8px;"></p>
  </div>

  <h2>‚ö° project silica 404sec</h2>

  <!-- Peer Controls -->
  <div id="peerArea">
    <span>Your ID:</span>
    <input id="my-id" readonly />
    <button id="copyIdBtn">Copy ID</button>
    <input id="connectId" placeholder="Friend's ID‚Ä¶" />
    <button onclick="connectToPeer()">Connect</button>
  </div>

  <!-- Room Registry Controls -->
  <div id="roomArea">
    <input id="roomName" placeholder="Room name‚Ä¶" />
    <button onclick="createRoom()">Create Room</button>
    <button onclick="listRooms()">List Rooms</button>
    <select id="roomList" style="min-width:120px;">
      <option value="" disabled selected>‚Äî select ‚Äî</option>
    </select>
    <button onclick="joinRoom()">Join Room</button>
  </div>

  <!-- Active Connections List -->
  <div id="connections"></div>

  <!-- Chat Display -->
  <div id="chatbox"></div>

  <!-- Message Input -->
  <div id="bottom">
    <input id="messageInput" placeholder="Type message‚Ä¶" />
    <button id="sendBtn" onclick="sendMessage()" disabled>Send</button>
  </div>

  <script>
  // CONFIG
  const REGISTRY_URL = 'http://localhost:3000';

  // USER & AVATAR
  let username = prompt("Choose your username:") || "Anonymous";
  let avatarURL = '';
  const styles = ["fun-emoji","pixel-art","bottts","identicon","adventurer","croodles"];
  const seedBase = username.replace(/\W+/g,'').toLowerCase() || 'guest';
  const grid = document.getElementById('avatarGrid');

  function refreshAvatars() {
    grid.innerHTML = '';
    for (let i=0; i<9; i++){
      const style = styles[Math.floor(Math.random()*styles.length)];
      const seed = seedBase + Math.floor(Math.random()*10000);
      const img = document.createElement('img');
      img.src = `https://api.dicebear.com/7.x/${style}/svg?seed=${seed}`;
      img.onclick = () => chooseAvatar(img.src);
      grid.appendChild(img);
    }
  }
  function chooseAvatar(url) {
    avatarURL = url;
    document.getElementById('avatarPicker').classList.remove('active');
    document.getElementById('lockScreen').classList.add('active');
  }
  function useCustomURL() {
    const url = document.getElementById('customURL').value.trim();
    if (url) chooseAvatar(url);
  }
  refreshAvatars();

  // LOCK SCREEN
  document.getElementById('unlockForm').addEventListener('submit', e => {
    e.preventDefault();
    if (document.getElementById('passwordInput').value === ':)00@') {
      document.getElementById('lockScreen').classList.remove('active');
    } else {
      document.getElementById('passwordMsg').textContent = '‚ùå Wrong password';
    }
  });

  // P2P & REGISTRY
  const peer = new Peer(), connections = {};
  const idInput = document.getElementById('my-id');
  const sendBtn = document.getElementById('sendBtn');
  const connDiv = document.getElementById('connections');

  peer.on('open', id => {
    idInput.value = id;
    listRooms();
  });

  peer.on('connection', c => {
    if (!connections[c.peer]) setupConnection(c);
  });

  function setupConnection(c) {
    connections[c.peer] = c;
    renderConnections();
    c.on('data', data => appendMessage(data, false));
    c.on('close', () => {
      delete connections[c.peer];
      appendSystemMsg(`Peer left: ${c.peer}`);
      renderConnections();
    });
    appendSystemMsg(`Connected: ${c.peer}`);
    renderConnections();
  }

  // COPY FRIEND ID
  document.getElementById('copyIdBtn').onclick = () => {
    navigator.clipboard.writeText(idInput.value)
      .then(() => alert('ID copied to clipboard'));
  };

  function connectToPeer() {
    const fid = document.getElementById('connectId').value.trim();
    if (!fid || connections[fid] || fid === peer.id) return;
    const c = peer.connect(fid);
    c.on('open', () => setupConnection(c));
  }

  async function createRoom() {
    const room = document.getElementById('roomName').value.trim();
    if (!room) return alert('Enter a room name');
    await fetch(`${REGISTRY_URL}/rooms`, {
      method: 'POST',
      headers: { 'Content-Type':'application/json' },
      body: JSON.stringify({ room })
    });
    document.getElementById('roomName').value = '';
    await listRooms();
  }

  async function listRooms() {
    try {
      const res = await fetch(`${REGISTRY_URL}/rooms`);
      const rooms = await res.json();
      const sel = document.getElementById('roomList');
      sel.innerHTML = '<option value="" disabled selected>‚Äî select ‚Äî</option>' +
        rooms.map(r => `<option value="${r}">${r}</option>`).join('');
    } catch (e) {
      console.error('Failed to list rooms', e);
    }
  }

  async function joinRoom() {
    const room = document.getElementById('roomList').value;
    if (!room) return alert('Select a room');
    // register on server
    await fetch(`${REGISTRY_URL}/rooms/${room}/join`, {
      method: 'POST',
      headers: { 'Content-Type':'application/json' },
      body: JSON.stringify({ peerId: peer.id })
    });
    appendSystemMsg(`Joined room: ${room}`);
    // get peers and connect
    const res = await fetch(`${REGISTRY_URL}/rooms/${room}/peers`);
    const peers = await res.json();
    peers.forEach(pid => {
      if (pid !== peer.id && !connections[pid]) {
        const c = peer.connect(pid);
        c.on('open', () => setupConnection(c));
      }
    });
  }

  function renderConnections() {
    connDiv.innerHTML = '<strong>Active Peers:</strong>';
    const ids = Object.keys(connections);
    if (!ids.length) {
      connDiv.innerHTML += '<div class="system">‚Äî none ‚Äî</div>';
    }
    ids.forEach(id => {
      const div = document.createElement('div');
      div.className = 'conn-item';
      div.innerHTML = `
        <span>${id}</span>
        <button onclick="disconnectPeer('${id}')">‚úñ</button>
      `;
      connDiv.appendChild(div);
    });
    sendBtn.disabled = ids.length === 0;
  }

  function disconnectPeer(id) {
    connections[id].close();
    delete connections[id];
    renderConnections();
    appendSystemMsg(`You disconnected: ${id}`);
  }

  // MESSAGING
  function sendMessage() {
    const input = document.getElementById('messageInput');
    const text = input.value.trim();
    if (!text) return;
    const payload = { user: username, avatar: avatarURL, text };
    appendMessage(payload, true);
    Object.values(connections).forEach(c => c.open && c.send(payload));
    input.value = '';
  }

  function appendMessage({ user, avatar, text }, isYou) {
    const div = document.createElement('div');
    div.className = 'message';
    div.innerHTML = `
      <img class="avatar" src="${avatar}" />
      <div class="text">
        <strong>${isYou ? 'You' : user}</strong>: ${text}
      </div>
    `;
    document.getElementById('chatbox').appendChild(div);
    chatbox.scrollTop = chatbox.scrollHeight;
  }

  function appendSystemMsg(msg) {
    const div = document.createElement('div');
    div.className = 'text system';
    div.textContent = msg;
    document.getElementById('chatbox').appendChild(div);
    chatbox.scrollTop = chatbox.scrollHeight;
  }
  </script>
</body>
</html>
